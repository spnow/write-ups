# ASIS Cyber Security Contest Quals 2014: Random Image

**Category:** Crypto
**Points:** 150
**Description:**

> Find the flag
> [file](crypto_150_8f3fd5d2bacd408904b8406c19183c23)

## Write-up

_This write-up is made by Steven of the [HacknamStyle](http://hacknamstyle.net/) CTF team._

The challenge contains this image:

![](enc.png)

…and a Python script:

```python
#!/usr/bin/env python

import Image
import random

def get_color(x, y, r):
  n = (pow(x, 3) + pow(y, 3)) ^ r
  return (n ^ ((n >> 8) << 8 ))

flag_img = Image.open("flag.png")
im = flag_img.load()
r = random.randint(1, pow(2, 256))
print flag_img.size

enc_img = Image.new(flag_img.mode, flag_img.size)
enpix = enc_img.load()

for x in range(flag_img.size[0]):
  for y in range(flag_img.size[1]):
    t = random.randint(1, pow(2, 256)) % 250
    enpix[x,y] = t


for x in range(flag_img.size[0]):
  for y in range(flag_img.size[1]):
    if im[x,y] < 250 :
      s = get_color(x, y, r)
      enpix[x,y] = s

enc_img.save('enc' + '.png')
```

The script is used to encode an image with the flag, and turns it into the given image.
Pixels with value lower than 250 are overwritten by the value generated by `get\_color(x, y, r)`.
This function generates a value based on the pixel location `(x,y)` and 256-bit random value `r`.
In `get\_color` we can see that the value is calculated by XORing the sum of the cubes of `x` and `y` with `r`, and then keeping the least significant 8 bits.

We don't have the random key `r`, but we can bruteforce it because only the least significant 8 bits are used.
For the correct version of `r`, `get\_color(x,y,r)` will generate a value that is identical to the one in [`enc.png`](enc.png).
Unfortunately, some pixels will contain random information instead (those which have values 250 and higher in the original flag image).

We give each of these 2 cases a different color. Pixels matching their `get\_pixel` value will be colored black, the rest is colored white. For each of the 256 possible values of `r`, we generate a ‘decoded’ image. By going through the image, we find that [`decoded\_38.png`](decoded_38.png) (for `r = 38`) contains the flag:

![](decoded_38.png)

[`color\_decrypto.py`](color_decrypto.py) contains the code for the solution.

## Other write-ups and resources

* <http://blog.squareroots.de/en/2014/05/asis-ctf-2014-color-crypto/>
* <http://www.incertia.net/blog/asis-2014-quals-random-image/>
* <http://blogs.univ-poitiers.fr/e-laize/2014/05/10/asis-2014-randomimage/>A
* <http://quangntenemy.blogspot.de/2014/05/asis-ctf-quals-2014.html>
* [Persian](http://xploit.ir/asis-2014-qulas-random-image/)
