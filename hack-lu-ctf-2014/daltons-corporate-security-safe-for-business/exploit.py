#!/usr/bin/env python
# coding=utf-8

import urllib, urllib2, re, base64, commands, cookielib, webbrowser, os, sys
from bs4 import BeautifulSoup
def getFlag(code,count):
	arr1=[]
	arr5=[]
	dict1={}
	ar = code.split('<script>')[1][:-26]
	ar = ar.split(";")
	for i in ar:
		if "String.fromCharCode" in i:
			arr1.append(chr(int(i.split('(')[1].split(')')[0])))
		if "atob" in i:
			arr1.append(base64.b64decode(i.split("'")[1]))
		if ".source" in i:
			arr1.append(i.split('/')[1])
		if ")[" in i:
			com = commands.getoutput("node -e \"console.log("+i.split("=")[1].replace("\"","\\\"")+");\"")
			arr1.append(com)
		if "toString" in i:
			com1 = commands.getoutput("node -e \"console.log("+i.split("=")[1]+");\"")
			arr1.append(com1)
		if "fillText" in i:
			arr5.append(i)
	for i in range(8):
		dict1[int(arr5[i].split(",")[1])] = arr1[i]
	fin_str=""
	for k in sorted(dict1.keys()):
		fin_str+=dict1[k]
	print "[+] Solution %d: %s"%(count,fin_str)
	data = urllib.urlencode({'solution' : fin_str})
	resp=opener.open('https://wildwildweb.fluxfingers.net:1422/',data)
	out=resp.read()
	soup=BeautifulSoup(out)
	po=soup.findAll(True, {"class":re.compile("^(pos|neg)$")})
	if(len(po)==0):
		mess="NO MESSAGE"
	else:
		mess=po[0].text
	if("VALID" in mess):
		va=str(soup.findAll(True,{"title":"Security Zone"})[0]).split("=")
		link=va[1][1:]+"="+va[2].split("\"")[0]
		resp=opener.open("https://wildwildweb.fluxfingers.net:1422/"+link)
		out=resp.read()
		print "[+] Congo!!! %s\n"%(out)
		sys.exit(0)
	print "[+] STATUS of %d => %s\n"%(count,mess)
	count+=1
	getFlag(out,count)
resp = urllib2.urlopen('https://wildwildweb.fluxfingers.net:1422/')
code=resp.read()
cj = cookielib.CookieJar()
opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cj))
getFlag(code,1)
